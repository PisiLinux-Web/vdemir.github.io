---
layout: post
title: Installing ClamAV for File Scanning
date:   2018-06-26 13:52:00
tags:   ClamAV
comments: False
---

{{ page.title }}
================
{% include CSS.html %}

<p class="meta">16 Ocak 2018 - Türkiye</p>

Virus scanning with ClamAV
-------------

Linux has experienced only a small number of viruses. Some of these viruses exist but aren't active, and they certainly don't propagate. As Linux on the desktop reaches critical mass, there's a possibility that more viruses will appear, but that may still be a long ways off. 

Linux plays a critical role in server systems. Thus, virus scanners for Linux are essential when serving e-mail or files to clients. If you can remove the viral threat before it hits the clients, those clients become safer and less prone to infection.

One open source virus scanner that deserves mentioning is ClamAV. You can plug ClamAV directly into e-mail servers, and it will scan for viruses as the e-mail arrives—before it's delivered to users' mailboxes. It also performs routine scans on files that are served up to clients via sharing.

ClamAV works as a client/server system, but you can use it as a stand-alone scanner as well. 
.

## Install ClamAV From Source

If you installed from sources, first uninstall the old version:

~~~
./configure

sudo make uninstall
~~~

Firstly, let's process A command to create a user with clamav,

~~~
useradd -g clamav -s /bin/false -c "Clam AntiVirus" clamav
~~~

Some OS's require you to add the group as well.

~~~
groupadd clamav
~~~

Create and chown the directories:

~~~
mkdir /var/log/clamav /var/lib/clamav /var/run/clamav
chmod 700 /var/run/clamav
touch /var/log/clamav/clamav.log /var/log/clamav/freshclam.log
touch /var/run/clamav/clamd.socket
~~~

~~~
chown -R clamav:clamav /var/log/clamav /var/lib/clamav /var/run/clamav 
chown clamav:clamav /var/log/clamav/freshclam.log /var/log/clamav/clamav.log
~~~


<div class='pull-right alert alert-warning' style="margin: 15px; text-align: center;">
  <img src="/images/clamav-1.jpg" alt="programs" class="img-responsive" width="470px" height="313px"/>
  <p><small>OpenSource &bull; ClamAv.</small></p>
</div>

Download the latest stable ClamAV distribution from https://www.clamav.net/downloads

Expand the distribution that include Linux Filesystem Hierarchy and cd into the resultant directory and build ClamAV using:

~~~
tar -xzf clamav-*
cd clamav*
./configure --prefix=/usr \
    --sbindir=/usr/sbin \
    --sysconfdir=/etc/clamav \
    --with-dbdir=/var/lib/clamav \
    --with-user=clamav \
    --with-group=clamav \
    --disable-rpath \
    --disable-clamav \
    --disable-llvm \
    --enable-zlib-vcheck \
    --disable-milter \
    --enable-clamdtop \
    --with-system-tommath \
    --with-libbz2-prefix=/usr \
    --enable-systemd \
    --with-zlib=/usr \
    --enable-id-check \
    --disable-gcc-vcheck \
    --disable-experimental
make
sudo make install
~~~
.

## Configuration


### Modify the freshclam configuration:

~~~
mv -fv /etc/clamav/freshclam.conf.sample /etc/clamav/freshclam.conf
nano -w /etc/clamav/freshclam.conf
chown clamav:clamav /etc/clamav/freshclam.conf
~~~

Comment out the line (put a # as the first character on the line) near the top that says simply:

~~~
# Example
LogSyslog yes
DatabaseDirectory /var/lib/clamav
UpdateLogFile /var/log/clamav/freshclam.log
LogFileMaxSize 2M
LogVerbose yes
PidFile /var/run/clamav/freshclam.pid
DatabaseOwner clamav
DatabaseMirror database.clamav.net
NotifyClamd /etc/clamav/clamd.conf
~~~

### Modify the clamd configuration;

~~~
mv -fv /etc/clamav/clamd.conf.sample /etc/clamav/clamd.conf
nano -w /etc/clamav/clamd.conf
chown clamav:clamav /etc/clamav/clamd.conf
~~~

~~~
# Example
LogFile /var/log/clamav/clamd.log
LogFileMaxSize 2M
LogTime yes
LogSyslog yes
LogVerbose yes
PidFile /var/run/clamav/clamd.pid
TemporaryDirectory /tmp
LocalSocket /var/run/clamav/clamd.socket
TCPSocket 3310
FixStaleSocket yes
User clamav
#TCPAddr 127.0.0.1
~~~

Save and close the files.

<div class='pull-right alert alert-warning' style="margin: 15px; text-align: center;">
  <img src="/images/clamav-2.jpg" alt="programs" class="img-responsive" width="569px" height="325px"/>
  <p><small>Filesystem Hierarchy &bull; Linux.</small></p>
</div>

Missing systemd service file
We didn’t get a systemd service file, so creating a quick file here. The process should be forking itself and start freshclam in daemon mode. In this case we configure it to check 4 times a day for new files.

### Create a new file /usr/lib/systemd/system/clamav-freshclam.service

~~~
# Run the freshclam as daemon
[Unit]
Description = freshclam scanner
After = network.target

[Service]
Type = forking
ExecStart = /usr/bin/freshclam -d -c 4
Restart = on-failure
PrivateTmp = true

[Install]
WantedBy=multi-user.target
~~~

Now enable and start the service.

~~~
[root@ system]# systemctl enable clam-freshclam.service
[root@ system]# systemctl start clam-freshclam.service
~~~

Check the status.

~~~
[root@ system]# systemctl status clam-freshclam.service

● clam-freshclam.service - freshclam scanner
   Loaded: loaded (/etc/systemd/system/clam-freshclam.service; enabled; vend>
   Active: active (running) since Sat 2018-06-23 12:31:50 +03; 4h 53min ago
 Main PID: 531 (freshclam)
    Tasks: 1 (limit: 4586)
   Memory: 808.0K
   CGroup: /system.slice/clam-freshclam.service
           └─531 /usr/bin/freshclam -d -c 4
~~~


### Next step is changing the clamd service file /usr/lib/systemd/system/clamav-daemon.service

~~~
[Unit]
Description = clamd scanner daemon
After = syslog.target nss-lookup.target network.target

[Service]
Type = simple
ExecStart = /usr/sbin/clamd -c /etc/clamav/clamd.conf --foreground=yes
Restart = on-failure
PrivateTmp = true

[Install]
WantedBy=multi-user.target
~~~

Move into the directory.
~~~
cd /usr/lib/systemd/system
~~~

Start all services.

~~~
[root@ system]# systemctl enable clam-freshclam.service
[root@ system]# systemctl enable clamav-daemon.service
[root@ system]# systemctl start clam-freshclam.service
[root@ system]# systemctl start clamav-daemon.service
~~~

<div class='pull-right alert alert-warning' style="margin: 15px; text-align: center;">
  <img src="/images/clamav-3.jpg" alt="programs" class="img-responsive" width="569px" height="325px"/>
  <p><small>Security &bull; ClamAv.</small></p>
</div>


