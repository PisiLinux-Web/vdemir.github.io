---
layout: post
title: Installing ClamAV for File Scanning
date:   2018-06-26 13:52:00
tags:   ClamAV
comments: False
---

{{ page.title }}
================
{% include CSS.html %}

<p class="meta">16 Ocak 2018 - Türkiye</p>

Virus scanning with ClamAV
-------------

Linux has experienced only a small number of viruses. Some of these viruses exist but aren't active, and they certainly don't propagate. As Linux on the desktop reaches critical mass, there's a possibility that more viruses will appear, but that may still be a long ways off. 

Linux plays a critical role in server systems. Thus, virus scanners for Linux are essential when serving e-mail or files to clients. If you can remove the viral threat before it hits the clients, those clients become safer and less prone to infection.

One open source virus scanner that deserves mentioning is ClamAV. You can plug ClamAV directly into e-mail servers, and it will scan for viruses as the e-mail arrives—before it's delivered to users' mailboxes. It also performs routine scans on files that are served up to clients via sharing.

ClamAV works as a client/server system, but you can use it as a stand-alone scanner as well. 

## Install ClamAV From Source

If you installed from sources, first uninstall the old version:

~~~
./configure

sudo make uninstall
~~~

Firstly, let's process A command to create a user with clamav,

~~~
useradd clamav
~~~

Some OS's require you to add the group as well.

~~~
groupadd clamav
~~~

Create and chown the directories:

~~~
mkdir /var/log/clamav /var/lib/clamav 
mkdir /var/run/clamav /etc/clamav/freshclam.conf
~~~

~~~
chown -R clamav:clamav /var/log/clamav /var/lib/clamav 
chown -R clamav:clamav /var/run/clamav /etc/clamav/freshclam.conf
~~~


<div class='pull-right alert alert-warning' style="margin: 15px; text-align: center;">
  <img src="/images/clamav-1.jpg" alt="programs" class="img-responsive" width="470px" height="313px"/>
  <p><small>OpenSource &bull; ClamAv.</small></p>
</div>

Download the latest stable ClamAV distribution from https://www.clamav.net/downloads

Expand the distribution that include Linux Filesystem Hierarchy and cd into the resultant directory and build ClamAV using:

~~~
tar -xzf clamav-*
cd clamav*
./configure --prefix=/usr \
    --sbindir=/usr/sbin \
    --sysconfdir=/etc/clamav \
    --with-dbdir=/var/lib/clamav \
    --with-user=clamav \
    --with-group=clamav \
    --disable-rpath \
    --disable-clamav \
    --disable-llvm \
    --enable-zlib-vcheck \
    --disable-milter \
    --enable-clamdtop \
    --with-system-tommath \
    --with-libbz2-prefix=/usr \
    --enable-systemd \
    --with-zlib=/usr \
    --enable-id-check \
    --disable-gcc-vcheck \
    --disable-experimental
make
make install
~~~
.

## Configuration

Modify the freshclam configuration:

~~~
mv -fv /etc/clamav/freshclam.conf.sample /etc/clamav/freshclam.conf
nano -w /etc/clamav/freshclam.conf
~~~

Comment out the line (put a # as the first character on the line) near the top that says simply:

~~~
# Example
DatabaseDirectory /var/lib/clamav
UpdateLogFile /var/log/freshclam.log
LogFileMaxSize 2M
LogVerbose yes
PidFile /var/run/freshclam.pid
DatabaseOwner clamav
DatabaseMirror database.clamav.net
~~~

Modify the clamd configuration;

~~~
mv -fv /etc/clamav/clamd.conf.sample /etc/clamav/clamd.conf
nano -w /etc/clamav/clamd.conf
~~~

Save and close the file.
<div class='pull-right alert alert-warning' style="margin: 15px; text-align: center;">
  <img src="/images/clamav-2.jpg" alt="programs" class="img-responsive" width="569px" height="325px"/>
  <p><small>Filesystem Hierarchy &bull; Linux.</small></p>
</div>

Change the following line:

~~~
~~~

Save and close that file.

Open up your `/etc/NetworkManager/NetworkManager.conf` file and make sure that it includes (at least) the line:

~~~
[main]
plugins=ifupdown,keyfile
dns=dnsmasq
~~~

Finally, open up your `/etc/resolv-dnsmasq.conf` file and make sure that it includes (at least) the line:

~~~
nameserver 208.67.222.222
nameserver 208.67.220.220
~~~

Optionally, you could increase the cache size for dnsmasq and change to 2048 for single machine or whatever size you might need (there is a hard-limit of 10000).

`echo "cache-size=2048" | sudo tee /etc/NetworkManager/dnsmasq.d/cache`

Restart the dnsmasq service with the systemd:


## Run Dnsmasq with systemd

Create `/etc/systemd/system/dnsmasq@.service` with these contents:

~~~bash
# '%i' becomes 'virbr10' when running
# `systemctl start dnsmasq@virbr10.service`
# Remember to run `systemctl daemon-reload`
# after creating or editing this file.


[Unit]
Description=DHCP and DNS caching server for %i.
After=network.target

[Service]
ExecStart=/usr/bin/dnsmasq -k --conf-file=/etc/dnsmasq.conf
ExecReload=/bin/kill -HUP $MAINPID
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
~~~

It is best to only start dnsmasq when the bridge is up. If using NetworkManager, create `/etc/NetworkManager/dispatcher.d/99-virbr10` and make it executable.

~~~bash
#!/bin/sh
# See the "DISPATCHER SCRIPTS" section of `man NetworkManager`.
# Remember to make this file executable!
[ "$1" != "virbr10" ] && exit 0
case "$2" in
    "up")
        /bin/systemctl start dnsmasq@virbr10.service || :
        ;;
    "down")
        /bin/systemctl stop dnsmasq@virbr10.service || :
        ;;
esac
~~~

If using Debian, append two command options to `/etc/network/interfaces`.

~~~bash
auto virbr10
iface virbr10 inet static
    ... snipped ...
    up /bin/systemctl start dnsmasq@virbr10.service || :
    down /bin/systemctl stop dnsmasq@virbr10.service || :
~~~

Alternatively, just start dnsmasq at every boot.

~~~bash
# systemctl enable dnsmasq@virbr10.service
# systemctl start dnsmasq@virbr10.service
~~~


## Testing the improvements

Testing dnsmasq is quite simple. 

~~~
$ dig www.google.com | grep "Query time"
~~~

Notice the query time of 48 msec.

Run the same command again, and you should see a considerable improvement over the query times.

We now see a 0 or near 0 query time for the same command. When a machine is having to query a significant amount of addresses, that time savings adds up.

## Vulnerabilities in the free DNS server Dnsmasq

Software developers and manufacturers should bring Dnsmasq up to date for security reasons.

<div class='pull-right alert alert-warning' style="margin: 15px; text-align: center;">
  <img src="/images/dnsmasq_security.jpeg" alt="programs" class="img-responsive" width="569px" height="325px"/>
  <p><small>Security &bull; Dnsmasq.</small></p>
</div>

## A much-needed improvement:

I've used dnsmasq on a number of Linux machines and always found it added a much-needed improvement to networking speeds. Give this easy DHCP and DNS caching nameserver a go and see if it doesn't find your Linux machines screaming on the network.
